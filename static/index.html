<!DOCTYPE html>
<html style="overflow-y:auto">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Phi Dashboard</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet"
          type="text/css">
    <link href="https://unpkg.com/vuetify/dist/vuetify.min.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="app">
    <v-app>
        <v-toolbar dense>
            <v-toolbar-side-icon>
                <v-icon large class="mb-4 grey--text">φ</v-icon>
            </v-toolbar-side-icon>
            <v-toolbar-title>Phi Dashboard</v-toolbar-title>
        </v-toolbar>
        <v-container v-if="mioDisabled">

            <v-layout column align-center class="title">
                <blockquote>
                    Phi Dashboard is disabled !
                </blockquote>
                <footer>
                    <small class="title">
                        未启用统计面板！
                    </small>
                </footer>
            </v-layout>
        </v-container>
        <v-container v-else
                     fluid
                     grid-list-lg>
            <v-layout row wrap>
                <v-flex offset-xs1 xs2>
                    <v-card height="350">
                        <v-card-title primary-title>
                            <div class="headline">Infos:</div>
                        </v-card-title>
                        <v-list dense>
                            <v-list-tile>
                                <v-list-tile-content>Version:</v-list-tile-content>
                                <v-list-tile-content class="align-end">{{status.nginx_version}}</v-list-tile-content>
                            </v-list-tile>
                            <v-list-tile>
                                <v-list-tile-content>Address:</v-list-tile-content>
                                <v-list-tile-content class="align-end">{{status.address}}</v-list-tile-content>
                            </v-list-tile>
                            <v-list-tile>
                                <v-list-tile-content>PID:</v-list-tile-content>
                                <v-list-tile-content class="align-end">{{status.pid}}</v-list-tile-content>
                            </v-list-tile>
                            <v-list-tile>
                                <v-list-tile-content>Uptime:</v-list-tile-content>
                                <v-list-tile-content class="align-end">{{new Date(status.load_timestamp *
                                    1000).toLocaleString()}}
                                </v-list-tile-content>
                            </v-list-tile>
                        </v-list>
                    </v-card>
                </v-flex>
                <v-flex xs6>
                    <v-card height="350">
                        <v-card-title primary-title>
                            <v-layout row wrap>
                                <v-flex>
                                    <div class="headline">Connections:</div>
                                </v-flex>
                                <v-flex>
                                    <v-list-tile-content class="align-end">Accepted : --</v-list-tile-content>
                                </v-flex>
                            </v-layout>
                        </v-card-title>
                        <br>
                        <br>
                        <br>
                        <br>
                        <v-card-actions>
                            <v-layout row wrap>
                                <v-flex>
                                    <div class="title text-xs-center">Current</div>
                                </v-flex>
                                <v-flex>
                                    <div class="title text-xs-center">Accepted</div>
                                </v-flex>
                                <v-flex>
                                    <div class="title text-xs-center">Active</div>
                                </v-flex>
                                <v-flex>
                                    <div class="title text-xs-center">Idle</div>
                                </v-flex>
                                <v-flex>
                                    <div class="title text-xs-center">Dropped</div>
                                </v-flex>
                            </v-layout>
                        </v-card-actions>
                        <v-card-actions>
                            <v-flex>
                                <v-layout row wrap>
                                    <v-flex>
                                        <div class="title text-xs-center">{{status.connections.current}}</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center">--</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center">{{status.connections.active}}</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center">{{status.connections.idle}}</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center">--</div>
                                    </v-flex>
                                </v-layout>
                            </v-flex>
                        </v-card-actions>
                    </v-card>
                </v-flex>
                <v-flex xs2>
                    <v-card height="350">
                        <v-card-title primary-title>
                            <v-layout row wrap>
                                <v-flex>
                                    <div class="headline">Requests:</div>
                                </v-flex>
                                <v-flex>
                                    <v-list-tile-content class="align-end">Total : {{status.requests.total}}
                                    </v-list-tile-content>
                                </v-flex>
                            </v-layout>
                        </v-card-title>
                        <br>
                        <br>
                        <br>
                        <br>
                        <v-card-actions>
                            <v-layout row wrap>
                                <v-flex>
                                    <div class="title text-xs-center">Current</div>
                                </v-flex>
                                <v-flex>
                                    <div class="title text-xs-center">Req/s</div>
                                </v-flex>
                            </v-layout>
                        </v-card-actions>
                        <v-card-actions>
                            <v-layout row wrap>
                                <v-flex>
                                    <div class="title text-xs-center">{{status.requests.current}}</div>
                                </v-flex>
                                <v-flex>
                                    <div class="title text-xs-center">{{status.requests.current}}</div>
                                </v-flex>
                            </v-layout>
                        </v-card-actions>
                    </v-card>
                </v-flex>
            </v-layout>
            <v-layout row wrap>
                <v-flex xs10 offset-xs1>
                    <v-layout row wrap>
                        <v-flex xs4>
                            <v-card height="350">
                                <v-toolbar dense class="elevation-0">
                                    <v-toolbar-title>Server zones</v-toolbar-title>
                                </v-toolbar>
                                <br>
                                <v-layout row wrap>
                                    <v-flex>
                                        <div class="title text-xs-center">Total</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center red--text">Problems</div>
                                    </v-flex>
                                </v-layout>
                                <br>
                                <v-layout row wrap>
                                    <v-flex>
                                        <div class="title text-xs-center">{{serverZone.total}}</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center red--text">{{serverZone.problems.length}}</div>
                                    </v-flex>
                                </v-layout>
                                <br>

                                <div class="title ml-4">Traffic</div>
                                <v-layout row wrap class="ml-2">
                                    <v-list-tile>
                                        <v-list-tile-content>In :</v-list-tile-content>
                                        <v-list-tile-content class="align-end">{{serverZone.trafficIn}} KiB/s
                                        </v-list-tile-content>
                                    </v-list-tile>
                                </v-layout>
                                <v-layout row wrap class="ml-2">
                                    <v-list-tile>
                                        <v-list-tile-content>Out :</v-list-tile-content>
                                        <v-list-tile-content class="align-end">{{serverZone.trafficOut}} KiB/s
                                        </v-list-tile-content>
                                    </v-list-tile>
                                </v-layout>
                            </v-card>
                        </v-flex>
                        <v-flex xs4>
                            <v-card height="350">
                                <v-toolbar dense class="elevation-0">
                                    <v-toolbar-title>Upstreams</v-toolbar-title>
                                </v-toolbar>
                                <br>
                                <v-layout row wrap>
                                    <v-flex>
                                        <div class="title text-xs-center">Total</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center yellow--text">Alerts</div>
                                    </v-flex>
                                </v-layout>
                                <br>
                                <v-layout row wrap>
                                    <v-flex>
                                        <div class="title text-xs-center">{{Object.keys(status.upstreams).length}}</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center yellow--text">{{servers.alerts.length}}</div>
                                    </v-flex>
                                </v-layout>
                                <br>
                                <div class="title ml-4">Servers</div>
                                <v-layout row wrap class="ml-2">
                                    <v-list-tile>
                                        <v-list-tile-content>All :</v-list-tile-content>
                                        <v-list-tile-content class="align-end">{{servers.all}}</v-list-tile-content>
                                    </v-list-tile>
                                </v-layout>
                                <v-layout row wrap class="ml-2">
                                    <v-list-tile>
                                        <v-list-tile-content class="green--text">Up :</v-list-tile-content>
                                        <v-list-tile-content class="align-end"> {{servers.up.length}}
                                        </v-list-tile-content>
                                    </v-list-tile>
                                    <v-list-tile>
                                        <v-list-tile-content class="red--text">Down :</v-list-tile-content>
                                        <v-list-tile-content class="align-end">{{servers.down.length}}
                                        </v-list-tile-content>
                                    </v-list-tile>
                                </v-layout>
                            </v-card>
                        </v-flex>
                        <v-flex xs4>
                            <v-card height="350">
                                <v-toolbar dense class="elevation-0">
                                    <v-toolbar-title>Caches</v-toolbar-title>
                                </v-toolbar>
                                <br>
                                <v-layout row wrap>
                                    <v-flex>
                                        <div class="title text-xs-center">Total</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center">Warnings</div>
                                    </v-flex>
                                </v-layout>
                                <br>
                                <v-layout row wrap>
                                    <v-flex>
                                        <div class="title text-xs-center">--</div>
                                    </v-flex>
                                    <v-flex>
                                        <div class="title text-xs-center">--</div>
                                    </v-flex>
                                </v-layout>
                                <br>
                                <div class="title ml-4">Cache States</div>
                                <v-layout row wrap class="ml-2">
                                    <v-list-tile>
                                        <v-list-tile-content class="red--text">Warm :</v-list-tile-content>
                                        <v-list-tile-content class="align-end">--</v-list-tile-content>
                                    </v-list-tile>
                                </v-layout>
                                <v-layout row wrap class="ml-2">
                                    <v-list-tile>
                                        <v-list-tile-content class="blue--text">Cold :</v-list-tile-content>
                                        <v-list-tile-content class="align-end">--</v-list-tile-content>
                                    </v-list-tile>
                                </v-layout>
                            </v-card>
                        </v-flex>
                    </v-layout>
                </v-flex>
            </v-layout>
        </v-container>
        <v-footer class="pa-3">
            <v-spacer></v-spacer>
            <div>&copy; {{ new Date().getFullYear() }}</div>
        </v-footer>
    </v-app>
</div>

<!--<script src="https://unpkg.com/vue/dist/vue.js"></script>-->
<!--<script src="https://unpkg.com/vuetify/dist/vuetify.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.5.0"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.16/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vuetify/1.0.11/vuetify.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue-resource/1.5.0/vue-resource.min.js"></script>
<script>
    function countUpstream(upstreams) {
        let all = 0;
        let up = [];
        let down = [];
        let alerts = [];
        let keys = Object.keys(upstreams);
        for (let i = 0; i < keys.length; i++) {
            let peers = upstreams[keys[i]].peers;
            all += peers.length;
            for (let j = 0; j < peers.length; j++) {
                let peer = peers[j];
                if (peer.down) {
                    down.push(peer)
                } else {
                    up.push(peer)
                }
                if (peer.fails > peer.requests || (peer.requests > 0 && peer.fails / peer.requests > 0.05)) {
                    alerts.push(peer)
                }
            }
        }
        return {
            all: all,
            up: up,
            down: down,
            alerts: alerts
        }
    }

    function countServerZone(server_zones) {
        let problems = [];
        let trafficIn = 0;
        let trafficOut = 0;
        let keys = Object.keys(server_zones);
        let total = keys.length;
        for (let i in keys) {
            let zone = server_zones[keys[i]];
            trafficIn += zone.receive_per_second;
            trafficOut += zone.send_per_second;
            if (zone.responses.total > 1000 && (zone.responses["5xx"] / zone.responses.total > 0.05)) {
                problems.push(zone)
            }
        }
        return {
            total: total,
            problems: problems,
            trafficIn: (trafficIn / 1024).toFixed(2),
            trafficOut: (trafficOut / 1024).toFixed(2)
        }
    }

    Vue.http.get('status').then(function (resp) {
        let mioDisabled = resp.body.mio_disabled;
        let data = mioDisabled ? {mioDisabled: true} : {
            mioDisabled: false,
            status: resp.body,
            servers: countUpstream(resp.body.upstreams),
            serverZone: countServerZone(resp.body.server_zones)
        };
        console.log(data)
        let app = new Vue({
            el: '#app',
            data: data
        });
        if (!mioDisabled) {
            setInterval(function () {
                Vue.http.get('/status').then(function (resp) {
                    app.status = resp.body;
                    app.servers = countUpstream(resp.body.upstreams);
                    app.serverZone = countServerZone(resp.body.server_zones);
                })
            }, 1000);
        }
    }, function (reason) {
        console.log(reason);
        alert("获取status失败！");
    });
</script>
</body>
</html>