<!DOCTYPE html>
<html lang="en" style="overflow: auto">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Phi Admin</title>
    <link href='https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Material+Icons' rel="stylesheet"
          type="text/css">
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="https://cdn.bootcss.com/vuetify/1.0.11/vuetify.min.css" rel="stylesheet">
    <link href="/static/css/materialdesignicons.min.css" media="all" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="app">
    <v-app>
        <v-toolbar dense>
            <v-toolbar-side-icon>
                <v-icon large class="mb-4 grey--text">φ</v-icon>
            </v-toolbar-side-icon>
            <v-toolbar-title>Phi Admin</v-toolbar-title>
        </v-toolbar>
        <v-container fluid class="ma-0 pa-0">
            <div id="main" style="width: auto;"></div>
        </v-container>
        <v-footer class="pa-3">
            <v-btn class="mt-0 mb-0" small icon @click="chartLayout='orthogonal'">
                <v-icon>mdi-file-tree</v-icon>
            </v-btn>
            <v-btn class="mt-0 mb-0" small icon @click="chartLayout='radial'">
                <v-icon>mdi-radio-tower</v-icon>
            </v-btn>
            <v-btn class="mt-0 mb-0" small icon @click="updateChart">
                <v-icon>refresh</v-icon>
            </v-btn>
            <v-spacer></v-spacer>
            <div>&copy; {{ new Date().getFullYear() }}</div>
        </v-footer>
        <v-dialog v-model="newApiServerDialog" persistent max-width="600px">
            <v-card>
                <v-card-title>
                    <span class="headline">New Api Server</span>
                </v-card-title>
                <v-card-text>
                    <v-container grid-list-md>
                        <v-form v-model="formValid" ref="routerForm">
                            <v-layout wrap>
                                <v-flex xs12 sm6 md6>
                                    <v-text-field :rules="formRules.string" label="Host" v-model="newRouter.hostkey"
                                                  hint="访问时使用的域名，如果是以IP访问，就输入ip:port" required></v-text-field>
                                </v-flex>
                                <v-flex xs12 sm6 md6>
                                    <v-select combobox clearable
                                              :rules="formRules.ups"
                                              label="Default Server"
                                              v-model="newRouter.data.default"
                                              :items="upstreams"
                                              required
                                              hint="可以是[ip:port]也可以是具体upstream名称"></v-select>
                                </v-flex>

                            </v-layout>
                        </v-form>
                    </v-container>
                    <small class="red--text">* 表示必填</small>
                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="blue darken-1" flat @click.native="newApiServerDialog = false">Close</v-btn>
                    <v-btn color="blue darken-1" flat :loading="formLoading" @click.native="newRouterApi">Save
                    </v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>
        <v-dialog v-model="updatePolicyDialog" scrollable persistent max-width="600px">
            <v-card>
                <v-card-title>
                    <span class="headline">Update Router Policy</span>
                </v-card-title>
                <v-card-text>
                    <v-container grid-list-md>
                        <v-form v-model="formValid" ref="policyForm">
                            <v-layout wrap>
                                <v-flex xs12 sm6 md6>
                                    <v-text-field :rules="formRules.string" label="Host"
                                                  v-model="newRouter.hostkey"
                                                  hint="访问时使用的域名，如果是以IP访问，就输入ip:port" required></v-text-field>
                                </v-flex>
                                <v-flex xs12 sm6 md6>
                                    <v-select combobox clearable
                                              :rules="formRules.ups"
                                              label="Default Server"
                                              v-model="newRouter.data.default"
                                              :items="upstreams"
                                              required
                                              hint="可以是[ip:port]也可以是具体upstream名称"></v-select>

                                </v-flex>
                            </v-layout>
                            <v-card class="elevation-0" v-if="newRouter.data.policies" v-for="p,p_idx in newRouter.data.policies">
                                <v-card-title>
                                    <v-flex xs11>
                                        <v-layout wrap>
                                            <v-flex xs12 sm3 md3>
                                                <v-text-field :rules="formRules.number" label="Order"
                                                              type="number"
                                                              v-model="p.order"
                                                              hint="规则优先级，越大优先级越高" required></v-text-field>
                                            </v-flex>
                                            <v-flex xs12 sm3 md3>
                                                <v-select :rules="formRules.string"
                                                          required
                                                          dense
                                                          auto
                                                          label="Policy"
                                                          v-model="p.policy"
                                                          :items="policies"
                                                          hint="规则的计算类型"></v-select>
                                            </v-flex>
                                            <v-flex xs12 sm3 md3 v-if="typeof(p.mapper)==='string'">
                                                <v-select :rules="formRules.string"
                                                          label="Mapper"
                                                          required
                                                          dense
                                                          auto
                                                          append-icon="fa-tags"
                                                          :append-icon-cb="()=>p.mapper={type:p.mapper,tag:''}"
                                                          :items="mappers"
                                                          v-model="p.mapper"
                                                          hint="提取请求特征的方式，点击tag图标可为此mapper添加tag字段"></v-select>
                                            </v-flex>
                                            <v-flex xs12 sm3 md3 v-if="typeof(p.mapper)==='object'">
                                                <v-select :rules="formRules.string"
                                                          label="Mapper"
                                                          v-model="p.mapper.type"
                                                          required
                                                          dense
                                                          auto
                                                          :items="mappers"
                                                          hint="提取请求特征的方式"></v-select>
                                            </v-flex>
                                            <v-flex xs12 sm3 md3 v-if="typeof(p.mapper)==='object'">
                                                <v-text-field :rules="formRules.string" label="Tag"
                                                              v-model="p.mapper.tag"
                                                              append-icon="close"
                                                              :append-icon-cb="()=>p.mapper=p.mapper.type"
                                                              hint="提取请求特征时的额外参数，可选"></v-text-field>
                                            </v-flex>
                                        </v-layout>
                                    </v-flex>
                                    <v-flex xs1>
                                        <v-btn icon @click="newRouter.data.policies.splice(p_idx,1)">
                                            <v-icon color="red">delete</v-icon>
                                        </v-btn>
                                    </v-flex>
                                </v-card-title>
                                <v-card-text>
                                    <v-layout row
                                              v-for="rp,rp_index in p.routerTable">
                                        <v-flex xs11>
                                            <v-layout row wrap>
                                                <v-flex xs6>
                                                    <v-select combobox clearable
                                                              :rules="formRules.ups"
                                                              label="Router Result"
                                                              v-model="rp.result"
                                                              :items="upstreams"
                                                              required
                                                              hint="路由结果"></v-select>
                                                </v-flex>
                                                <v-flex xs6>
                                                    <v-layout wrap v-if="'range' === p.policy">
                                                        <v-flex xs6>
                                                            <v-text-field
                                                                    :rules="formRules.string"
                                                                    label="From"
                                                                    v-model="rp.expression[0]"
                                                                    required
                                                                    hint="最小值，填写NONE表示大于End"></v-text-field>
                                                        </v-flex>
                                                        <v-flex xs6>
                                                            <v-text-field
                                                                    :rules="formRules.string"
                                                                    label="End"
                                                                    required
                                                                    v-model="rp.expression[1]"
                                                                    hint="最大值，填写NONE表示小于From"></v-text-field>
                                                        </v-flex>
                                                    </v-layout>
                                                    <v-layout v-else>
                                                        <v-flex xs12>
                                                            <v-text-field
                                                                    :rules="formRules.string"
                                                                    label="Router Condition"
                                                                    v-model="rp.expression"
                                                                    required
                                                                    hint="路由匹配条件"></v-text-field>
                                                        </v-flex>
                                                    </v-layout>
                                                </v-flex>
                                            </v-layout>
                                        </v-flex>
                                        <v-flex xs1>
                                            <v-btn icon small
                                                   @click="p.routerTable.splice(rp_index,1)">
                                                <v-icon small>fa-minus</v-icon>
                                            </v-btn>
                                        </v-flex>
                                    </v-layout>
                                    <v-layout>
                                        <v-btn block flat round small
                                               @click="p.routerTable.push({result:'',expression:[]})">
                                            <v-icon small>fa-plus</v-icon>
                                            &nbsp;Add New Policy Item
                                        </v-btn>
                                    </v-layout>
                                </v-card-text>
                                <v-card-actions>
                                    <v-divider></v-divider>
                                </v-card-actions>
                            </v-card>
                        </v-form>
                    </v-container>
                </v-card-text>
                <v-card-actions>
                    <small class="red--text">* 表示必填</small>
                    <v-spacer></v-spacer>
                    <v-btn color="blue darken-1" flat
                           @click.native="addPolicy">
                        Add
                    </v-btn>
                    <v-btn color="blue darken-1" flat @click.native="updatePolicyDialog = false">Close</v-btn>
                    <v-btn color="blue darken-1" flat :loading="formLoading" @click.native="newRouterApi">Save
                    </v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>
        <v-dialog v-model="newUpstreamDialog" persistent max-width="600px">
            <v-card>
                <v-card-title>
                    <span class="headline">New Upstream</span>
                </v-card-title>
                <v-card-text>
                    <v-container grid-list-md>
                        <v-form v-model="formValid" ref="upstreamForm">
                            <v-layout wrap>
                                <v-flex xs12>
                                    <v-layout wrap>
                                        <v-flex xs12 sm6 md6>
                                            <v-text-field :rules="formRules.string" label="Upstream Name"
                                                          v-model="newUpstream.upstreamName"
                                                          hint="Upstream组名称" required></v-text-field>
                                        </v-flex>
                                        <v-flex xs12 sm6 md6>
                                            <v-select required :rules="formRules.string"
                                                      label="Load Balance Strategy"
                                                      v-model="newUpstream.strategy"
                                                      :items="balancers"
                                                      hint="负载均衡策略"></v-select>
                                        </v-flex>
                                        <v-flex xs12 sm6 md6
                                                v-if="newUpstream.strategy=='resty_chash' && typeof(newUpstream.mapper)==='string'">
                                            <v-select :rules="formRules.string"
                                                      label="Mapper"
                                                      required
                                                      dense
                                                      auto
                                                      append-icon="fa-tags"
                                                      :append-icon-cb="()=>newUpstream.mapper={type:newUpstream.mapper,tag:''}"
                                                      :items="mappers"
                                                      v-model="newUpstream.mapper"
                                                      hint="提取请求特征的方式，点击tag图标可为此mapper添加tag字段"></v-select>
                                        </v-flex>
                                        <v-flex xs12 sm6 md6
                                                v-if="newUpstream.strategy=='resty_chash' && typeof(newUpstream.mapper)==='object'">
                                            <v-select :rules="formRules.string"
                                                      label="Mapper"
                                                      v-model="newUpstream.mapper.type"
                                                      required
                                                      dense
                                                      auto
                                                      :items="mappers"
                                                      hint="提取请求特征的方式"></v-select>
                                        </v-flex>
                                        <v-flex xs12 sm6 md6
                                                v-if="newUpstream.strategy=='resty_chash' && typeof(newUpstream.mapper)==='object'">
                                            <v-text-field :rules="formRules.string" label="Tag"
                                                          v-model="newUpstream.mapper.tag"
                                                          append-icon="close"
                                                          :append-icon-cb="()=>newUpstream.mapper=newUpstream.mapper.type"
                                                          hint="提取请求特征时的额外参数，可选"></v-text-field>
                                        </v-flex>
                                    </v-layout>
                                </v-flex>

                                <v-flex xs12 v-for="s,s_idx in newUpstream.servers">
                                    <v-layout wrap>
                                        <v-flex xs11>
                                            <v-layout row wrap>
                                                <v-flex xs6>
                                                    <v-text-field required :rules="formRules.ip" label="Server Name"
                                                                  v-model="s.name"
                                                                  hint="主机ip:port,注意这里不支持域名解析！"></v-text-field>
                                                </v-flex>
                                                <v-flex xs6>
                                                    <v-text-field required :rules="formRules.string"
                                                                  label="Server Weight"
                                                                  v-model="s.info.weight"
                                                                  type="number"
                                                                  hint="主机权重值，决定了负载均衡时的流量大小"></v-text-field>
                                                </v-flex>
                                            </v-layout>
                                        </v-flex>
                                        <v-flex xs1>
                                            <v-btn icon small
                                                   @click="newUpstream.servers.splice(s_idx,1)">
                                                <v-icon small>fa-minus</v-icon>
                                            </v-btn>
                                        </v-flex>
                                    </v-layout>
                                </v-flex>
                                <v-flex xs12>
                                    <v-btn block round small
                                           @click="newUpstream.servers.push({name:'',info:{weight:0}})">
                                        <v-icon small>fa-plus</v-icon>
                                        &nbsp;添加新主机到此集群
                                    </v-btn>
                                </v-flex>
                            </v-layout>
                        </v-form>
                    </v-container>
                    <small class="red--text">* 表示必填</small>
                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="blue darken-1" flat @click.native="newUpstreamDialog = false">Close</v-btn>
                    <v-btn color="blue darken-1" flat :loading="formLoading" @click.native="newUpstreamApi">Save
                    </v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>
        <v-dialog v-model="newServerDialog" persistent max-width="600px">
            <v-card>
                <v-card-title>
                    <span class="headline">Add Server To Upstream</span>
                </v-card-title>
                <v-card-text>
                    <v-container grid-list-md>
                        <v-form v-model="formValid" ref="serverForm">
                            <v-layout wrap>
                                <v-flex xs12 sm6 md6>
                                    <v-text-field required :rules="formRules.ip" label="Server Name"
                                                  v-model="newServer.name"
                                                  hint="主机ip:port,注意这里不支持域名解析！"></v-text-field>
                                </v-flex>
                                <v-flex xs12 sm6 md6>
                                    <v-text-field required :rules="formRules.string" label="Server Weight"
                                                  v-model="newServer.info.weight"
                                                  type="number"
                                                  hint="主机权重值，决定了负载均衡时的流量大小"></v-text-field>
                                </v-flex>
                            </v-layout>
                        </v-form>
                    </v-container>
                    <small class="red--text">* 表示必填</small>
                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="blue darken-1" flat @click.native="newServerDialog = false">Close</v-btn>
                    <v-btn color="blue darken-1" flat :loading="formLoading"
                           @click.native="addServerToUpsApi(node.name)">Save
                    </v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>
        <v-menu
                lazy
                offset-y
                v-model="menu.phi"
                absolute
                :position-x="x"
                :position-y="y"
        >
            <v-list dense>
                <v-list-tile @click="newApiServerDialog=true">
                    <v-list-tile-title>New Api Server</v-list-tile-title>
                </v-list-tile>
            </v-list>
        </v-menu>
        <v-menu
                lazy
                offset-y
                v-model="menu.ups_root"
                absolute
                :position-x="x"
                :position-y="y"
        >
            <v-list dense>
                <v-list-tile @click="newUpstreamDialog=true">
                    <v-list-tile-title>New Upstream</v-list-tile-title>
                </v-list-tile>
            </v-list>
        </v-menu>
        <v-menu
                lazy
                offset-y
                v-model="menu.host"
                absolute
                :position-x="x"
                :position-y="y"
        >
            <v-list dense>
                <v-list-tile @click="updatePolicy">
                    <v-list-tile-title>Edit Route Policy</v-list-tile-title>
                </v-list-tile>
                <v-list-tile @click="delRouterApi(node.name)">
                    <v-list-tile-title>Delete Api Server</v-list-tile-title>
                </v-list-tile>
            </v-list>
        </v-menu>
        <v-menu
                lazy
                offset-y
                v-model="menu.upstream"
                absolute
                :position-x="x"
                :position-y="y"
        >
            <v-list dense>
                <v-list-tile @click="updateUpstream" v-if="!node.stable">
                    <v-list-tile-title>Edit Upstream</v-list-tile-title>
                </v-list-tile>
                <v-list-tile @click="delUpstreamApi(node.name)" v-if="!node.stable">
                    <v-list-tile-title>Delete Upstream</v-list-tile-title>
                </v-list-tile>
                <v-list-tile @click="newServerDialog=true" v-if="!node.stable">
                    <v-list-tile-title>Add Server To Upstream</v-list-tile-title>
                </v-list-tile>
            </v-list>
        </v-menu>
        <v-menu
                lazy
                offset-y
                v-model="menu.server"
                absolute
                :position-x="x"
                :position-y="y"
        >
            <v-list dense>
                <v-list-tile @click="deleteServerFromUpsApi(node.ups)" v-if="!node.stable">
                    <v-list-tile-title>Delete Server</v-list-tile-title>
                </v-list-tile>
                <v-list-tile @click="setPeerDown(node.ups)">
                    <v-list-tile-title>Server Up/Down</v-list-tile-title>
                </v-list-tile>
            </v-list>
        </v-menu>
        <v-snackbar
                :color="alertOption.color"
                :timeout="alertOption.timeout"
                :top="alertOption.y === 'top'"
                :bottom="alertOption.y === 'bottom'"
                :right="alertOption.x === 'right'"
                :left="alertOption.x === 'left'"
                :multi-line="alertOption.mode === 'multi-line'"
                :vertical="alertOption.mode === 'vertical'"
                v-model="alertOption.show"
                class="black--text"
        >
            {{ alertOption.message }}
            <v-btn flat icon color="pink" @click.native="alertOption.show = false">
                <v-icon>close</v-icon>
            </v-btn>
        </v-snackbar>
        <v-dialog v-model="confirmOption.show" max-width="290">
            <v-card>
                <v-card-title dense :class="confirmOption.color">Confirm ?</v-card-title>
                <v-card-text>
                    {{confirmOption.message}}
                </v-card-text>
                <v-card-actions>
                    <v-spacer></v-spacer>
                    <v-btn color="green darken-1" flat @click.native="confirmOption.show = false">No</v-btn>
                    <v-btn color="green darken-1" flat @click.native="confirmFunc">Yes</v-btn>
                </v-card-actions>
            </v-card>
        </v-dialog>
    </v-app>
</div>
</body>
<script src="https://cdn.bootcss.com/vue/2.5.16/vue.min.js"></script>
<script src="https://cdn.bootcss.com/vuetify/1.0.11/vuetify.min.js"></script>
<script src="https://cdn.bootcss.com/vue-resource/1.5.0/vue-resource.min.js"></script>
<script src="https://cdn.bootcss.com/echarts/4.0.4/echarts.min.js"></script>
<script src="/static/admin.js"></script>
</html>